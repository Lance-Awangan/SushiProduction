<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- Basic meta -->
    <meta charset="UTF-8" />
    <title>寿司 日次生産アプリ v0.2</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- PWA manifest (Android & others) -->
    <link rel="manifest" href="manifest.json" />

    <!-- Theme color for Android status bar -->
    <meta name="theme-color" content="#1976d2" />

    <!-- iOS: enable PWA mode (fullscreen) -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="寿司生産">

    <!-- iOS: app icon (home screen) -->
    <link rel="apple-touch-icon" href="icons/apple-icon-180.png">

    <!-- Optional: iOS splash screens (you can skip at first) -->
    <!-- Example sizes (you add these files only if you want custom splash) -->
    <!--
    <link rel="apple-touch-startup-image" href="/splash/splash-640x1136.png"
          media="(device-width: 320px) and (device-height: 568px)
                 and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/splash/splash-750x1334.png"
          media="(device-width: 375px) and (device-height: 667px)
                 and (-webkit-device-pixel-ratio: 2)">
    -->
    <style>
        :root {
            --bg: #f5f5f7;
            --card-bg: #ffffff;
            --text-main: #111827;
            --text-sub: #4b5563;
            --accent: #2563eb;
            --accent-soft: #dbeafe;
            --border-subtle: #e5e7eb;
            --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
        }

            :root.dark {
                --bg: #050816;
                --card-bg: #020617;
                --text-main: #f9fafb;
                --text-sub: #9ca3af;
                --accent: #60a5fa;
                --accent-soft: #0b1220;
                --border-subtle: #1f2933;
                --shadow-soft: 0 16px 40px rgba(15, 23, 42, 0.7);
            }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", "Segoe UI", sans-serif;
            margin: 0;
            padding: 12px;
            background: radial-gradient(circle at top, #e0f2fe 0, var(--bg) 55%);
            color: var(--text-main);
            min-height: 100vh;
        }

        .app-shell {
            max-width: 960px;
            margin: 0 auto;
        }

        .toolbar {
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(16px);
            margin-bottom: 10px;
        }

        .toolbar-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 8px 10px;
            border-radius: 16px;
            background: color-mix(in srgb, var(--card-bg) 85%, transparent);
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.15);
        }

        .title-area {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .title-main {
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 0.03em;
        }

        .title-sub {
            font-size: 0.75rem;
            color: var(--text-sub);
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .chip {
            font-size: 0.68rem;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            color: var(--text-sub);
            background: color-mix(in srgb, var(--card-bg) 80%, transparent);
        }

            .chip strong {
                color: var(--accent);
            }

        .btn {
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid transparent;
            font-size: 0.78rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
        }

            .btn.secondary {
                background: color-mix(in srgb, var(--card-bg) 90%, var(--accent-soft));
                color: var(--text-main);
                border-color: var(--border-subtle);
                box-shadow: none;
            }

            .btn.icon-only {
                padding-inline: 8px;
                width: 32px;
                justify-content: center;
            }

            .btn:active {
                transform: translateY(1px);
                box-shadow: none;
                opacity: 0.95;
            }

        .cards {
            margin-top: 12px;
            display: grid;
            grid-template-columns: minmax(0, 1fr);
            gap: 10px;
        }

        @media (min-width: 720px) {
            .cards {
                grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 10px 12px;
            box-shadow: var(--shadow-soft);
            border: 1px solid color-mix(in srgb, var(--border-subtle) 60%, transparent);
            font-size: 0.85rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            gap: 8px;
        }

        .name {
            font-weight: 600;
            font-size: 0.95rem;
            padding: 2px 8px;
            border-radius: 999px;
            background: var(--accent-soft);
            color: var(--accent);
        }

        .pack-input-wrap {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .pack-label {
            font-size: 0.7rem;
            color: var(--text-sub);
        }

        input[type="number"] {
            width: 70px;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            background: color-mix(in srgb, var(--card-bg) 95%, #0f172a 5%);
            text-align: right;
            font-size: 0.85rem;
            color: var(--text-main);
        }

            input[type="number"]:focus {
                outline: 2px solid var(--accent-soft);
                border-color: var(--accent);
            }

        .rows-grid {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
            gap: 4px 10px;
            margin-top: 4px;
        }

        .card-row {
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 3px 0;
            border-bottom: 1px dashed color-mix(in srgb, var(--border-subtle) 80%, transparent);
        }

            .card-row:last-child {
                border-bottom: none;
            }

            .card-row label {
                font-size: 0.7rem;
                color: var(--text-sub);
            }

            .card-row span {
                font-size: 0.83rem;
            }

        .totals {
            margin-top: 12px;
            padding: 10px 12px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-soft);
            border: 1px solid color-mix(in srgb, var(--border-subtle) 70%, transparent);
            font-size: 0.85rem;
        }

        .totals-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .totals-title {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .totals-body {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
            gap: 4px 12px;
        }

        .totals-row {
            display: flex;
            justify-content: space-between;
            gap: 4px;
        }

            .totals-row span:first-child {
                font-size: 0.78rem;
                color: var(--text-sub);
            }

            .totals-row span:last-child {
                font-weight: 500;
            }

        .version-tag {
            font-size: 0.7rem;
            color: var(--text-sub);
        }

        .section-label {
            margin-top: 12px;
            margin-bottom: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-sub);
            padding: 0 4px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            opacity: 0.8;
        }

        /* ---- PRINT VIEW (1 column) ---- */

        #printView {
            display: none;
            font-family: system-ui, -apple-system, "SF Pro Text", "Helvetica Neue", "Segoe UI", sans-serif;
            font-size: 12px;
        }

        @media print {
            body {
                background: #ffffff;
                padding: 0;
                margin: 0;
            }

            .app-shell {
                display: none !important; /* 通常UIは印刷しない */
            }

            #printView {
                display: block !important;
                padding: 10mm 12mm;
            }

            .print-title {
                font-size: 20px;
                font-weight: 700;
                margin-bottom: 4mm;
            }

            .print-date {
                margin-bottom: 3mm;
            }

            .print-hr {
                border: none;
                border-top: 2px solid #000;
                margin: 4mm 0;
            }

            .section-label-print {
                font-weight: 700;
                margin: 3mm 0 2mm;
                font-size: 14px;
            }

            .print-section {
                margin-bottom: 6mm;
                page-break-inside: avoid;
            }

            .print-section-products {
                page-break-after: always; /* product section ends the page */
            }

            .print-section-ingredients {
                page-break-before: auto; /* no extra break here */
            }

            table.print-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 4mm;
                font-size: 12px;
            }

                table.print-table th,
                table.print-table td {
                    border: 1px solid #000;
                    padding: 3px 6px;
                    text-align: left;
                    vertical-align: top;
                }

                table.print-table th {
                    background: #f3f4f6;
                }
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <header class="toolbar">
            <div class="toolbar-inner">
                <div class="title-area">
                    <div class="title-main">寿司 日次生産入力</div>
                    <div class="title-sub">シャリ・巻物・金額を自動集計するミニアプリ</div>
                </div>
                <div class="toolbar-right">
                    <div class="chip">
                        <strong id="versionBadge"></strong>・オフライン対応
                    </div>
                    <button class="btn secondary" id="darkToggle" title="ダークモード切替">
                        🌙
                    </button>
                    <button class="btn secondary" id="addProductToggleBtn">
                        ＋ 新商品
                    </button>
                    <button class="btn secondary" id="saveBtn">
                        💾 保存
                    </button>
                    <button class="btn secondary" id="csvBtn">
                        📄 CSV
                    </button>
                    <button class="btn secondary" id="resetBtn">
                        ♻ リセット
                    </button>
                    <button class="btn" id="printBtn">
                        🖨 印刷
                    </button>
                </div>
            </div>
        </header>
        <main>
            <section id="addProductPanel" style="display:none; margin-top:8px;">
                <div class="card" style="box-shadow:none; border-style:dashed;">
                    <div style="font-weight:600; margin-bottom:4px;">新商品を追加</div>
                    <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:flex-end; font-size:0.8rem;">
                        <label>商品名<br><input id="newProductName" type="text" style="width:120px;"></label>
                        <label>価格(円)<br><input id="newProductPrice" type="number" style="width:80px;"></label>
                        <label>1Pシャリ(貫)<br><input id="newProductShari" type="number" step="0.1" style="width:80px;"></label>
                        <label>巻物シャリ(g)<br><input id="newProductMakiG" type="number" step="1" style="width:80px;"></label>
                        <label>
                            ネタ構成 (例: 大トロ:4, サーモン:4)<br>
                            <input id="newProductNetaConfig" type="text" style="min-width:260px;">
                        </label>
                        <button class="btn" id="newProductSaveBtn">追加</button>
                        <button class="btn secondary" id="newProductCancelBtn">キャンセル</button>
                    </div>
                </div>
            </section>
            <section class="cards" id="cards"></section>
            <section class="totals" id="totals">
                <div class="totals-header">
                    <div class="totals-title">本日サマリー</div>
                    <div class="version-tag">寿司アプリ v0.1</div>
                </div>
                <div class="totals-body" id="totalsBody"></div>
            </section>
        </main>
    </div>

    <!-- 印刷専用ビュー -->
    <div id="printView"></div>

    <script>
        const APP_VERSION = "0.2.2";
        const STORAGE_KEY = "sushi_daily_packs";
        /**
         * Constant: grams per 1 kan (貫)
         * Changing this affects all kg calculations.
         */
        const GRAMS_PER_KAN = 16;

        /**
         * PRODUCTS:
         * The master product list used to build the UI.
         * - name: Display name
         * - price: Price per pack (JPY)
         * - shariPer: Shari per pack (kan)
         * - makiG: Rice grams for makimono (0 for nigiri items)
         */
        const BASE_PRODUCTS = [
            { name: "真", price: 7990, shariPer: 40.0, makiG: 0.0 },
            { name: "美", price: 4990, shariPer: 33.0, makiG: 160.0 },
            { name: "善", price: 5990, shariPer: 36.0, makiG: 160.0 },
            { name: "海峡", price: 3990, shariPer: 24.0, makiG: 0.0 },
            { name: "さざ波", price: 2800, shariPer: 24.0, makiG: 0.0 },
            { name: "松", price: 1590, shariPer: 10.0, makiG: 0.0 },
            { name: "竹", price: 1390, shariPer: 10.0, makiG: 0.0 },
            { name: "梅", price: 1290, shariPer: 6.0, makiG: 80.0 },
            { name: "赤レンジアー", price: 1200, shariPer: 6.0, makiG: 80.0 },
            { name: "紅白レンジアー", price: 990, shariPer: 9.0, makiG: 0.0 },
            { name: "虹レンジアー", price: 990, shariPer: 8.0, makiG: 40.0 },
            { name: "橙レンジアー", price: 990, shariPer: 6.0, makiG: 80.0 },
            { name: "茶助レンジアー", price: 990, shariPer: 3.0, makiG: 0.0 },
            { name: "青レンジアー", price: 990, shariPer: 3.0, makiG: 0.0 },
            { name: "マグロ", price: 690, shariPer: 6.0, makiG: 0.0 },
            { name: "タイ", price: 680, shariPer: 6.0, makiG: 0.0 },
            { name: "サモン", price: 680, shariPer: 6.0, makiG: 0.0 },
            { name: "ぶり", price: 699, shariPer: 6.0, makiG: 0.0 },
            { name: "エビ", price: 590, shariPer: 6.0, makiG: 0.0 },
            { name: "あじ", price: 599, shariPer: 6.0, makiG: 0.0 },
            { name: "鉄火巻き", price: 599, shariPer: 0.0, makiG: 80.0 },
            { name: "ネギトロ巻き", price: 499, shariPer: 0.0, makiG: 80.0 },
            { name: "海鮮巻き", price: 599, shariPer: 0.0, makiG: 230.0 },
            { name: "海鮮丼", price: 990, shariPer: 0.0, makiG: 200.0 },
            { name: "昆布巻き", price: 499, shariPer: 0.0, makiG: 140.0 },
            { name: "サモン巻き", price: 450, shariPer: 0.0, makiG: 120.0 },
            { name: "トロタク巻き", price: 499, shariPer: 0.0, makiG: 120.0 },
        ];

        /**
         * PRODUCT → NETA (ingredient) breakdown
         * 各商品1パックあたり、ネタ何枚かを定義する。
         * ここはお店の「一定」シートに合わせて調整してください。
         */
        const DEFAULT_PRODUCT_NETA_MAP = {
            "真": {
                "大トロ": 4,
                "中トロ": 4,
                "サーモン": 4,
                "カンパチ": 4,
                "生エビ": 4,
                "エンガワ": 4,
                "いくら": 4,
                "うに": 4,
                "タマゴ": 4,
                "ぶり": 4,
            },
            "美": {
                "中トロ": 3,
                "サーモン": 3,
                "マグロ": 3,
                "イカ": 3,
                "生エビ": 3,
                "カンパチ": 3,
                "タイ": 3,
                "いくら": 2,
                "うに": 2,
                "ネギとろ": 2,
                "タマゴ": 3,
                "穴子": 3,
            },
            "善": {
                "マグロ": 4,
                "イカ": 4,
                "カンパチ": 4,
                "サーモン": 4,
                "寿エビ": 4,
                "タイ": 4,
                "いくら": 4,
                "ネギとろ": 4,
                "穴子": 4,
                "角タマ": 4,
            },
            "海峡": {
                "大トロ": 3,
                "中トロ": 3,
                "サーモン": 3,
                "カンパチ": 3,
                "いくら": 3,
                "生エビ": 3,
                "タイ": 3,
                "イカ": 3,
            },
            "さざ波": {
                "マグロ": 6,
                "サーモン": 3,
                "カンパチ": 3,
                "いくら": 3,
                "生エビ": 3,
                "イカ": 3,
                "タマゴ": 3,
            },
            "松": {
                "中トロ": 2,
                "サーモン": 1,
                "カンパチ": 1,
                "エンガワ": 1,
                "生エビ": 1,
                "タイ": 1,
                "いくら": 1,
                "うに": 1,
                "タマゴ": 1,
            },
            "竹": {
                "本赤み": 2,
                "イカ": 1,
                "サーモン": 1,
                "タイ": 1,
                "カンパチ": 1,
                "寿エビ": 1,
                "いくら": 1,
                "ネギとろ": 1,
                "タマゴ": 1,
            },
            "梅": {
                "マグロ": 1,
                "イカ": 1,
                "サーモン": 1,
                "カンパチ": 1,
                "角タマ": 1,
                "生エビ": 1,
                "タイ": 1,
            },
            "赤レンジアー": {
                "大トロ": 3,
                "マグロ": 3,
            },
            "紅白レンジアー": {
                "マグロ": 3,
                "タイ": 3,
                "イカ": 3,
            },
            "虹レンジアー": {
                "マグロ": 1,
                "イカ": 1,
                "寿エビ": 1,
                "いくら": 2,
                "ネギとろ": 1,
                "タマゴ": 2,
            },
            "橙レンジアー": {
                "サーモン": 3,
                "焼サモン": 3,
            },
            //"茶助レンジアー": {},
            "青レンジアー": {
                "あじ": 3,
            },
            "マグロ": { "マグロ": 6 },
            "タイ": { "タイ": 6 },
            "サモン": { "サーモン": 6 },
            "ぶり": { "ぶり": 6 },
            "寿エビ": { "寿エビ": 6 },
            "あじ": { "あじ": 6 },
        };

        // Runtime lists (default + user-added)
        let PRODUCTS = [];
        let PRODUCT_NETA_MAP = {};

        const PRODUCTS_STORAGE_KEY = "sushi_products_v1";
        const NETA_MAP_STORAGE_KEY = "sushi_neta_map_v1";

        let EDITING_PRODUCT_ID = null;

        // ===== Helpers / CRUD =====
        function getTodayISO() {
            const d = new Date();
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, "0");
            const day = String(d.getDate()).padStart(2, "0");
            return `${y}-${m}-${day}`;
        }

        function restoreFromStorage() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return;

            try {
                let data = JSON.parse(raw);
                data = normalizeDailyPayload(data); // ✅ add this (supports packs + lines)

                // Build lookup: productId -> qty
                const qtyById = {};
                (data.lines || []).forEach(line => {
                    qtyById[line.productId] = Number(line.qty || 0);
                });

                // Fill inputs using current PRODUCTS index -> productId mapping
                const inputs = cardsDiv.querySelectorAll('input[data-index]');
                inputs.forEach(input => {
                    const id = input.dataset.productId;
                    input.value = qtyById[p.id] || 0;
                });
            } catch (e) {
                console.error("restoreFromStorage failed", e);
            }
        }

        function normalizeDailyPayload(payload) {
            if (payload && Array.isArray(payload.lines)) return payload;

            // old format
            if (payload && Array.isArray(payload.packs)) {
                const lines = payload.packs
                    .map((qty, index) => {
                        const p = PRODUCTS[index];
                        const n = Number(qty || 0);
                        if (!p || n === 0) return null;
                        return {
                            productId: p.id,
                            qty: n,
                            snap: { name: p.name, price: p.price, shariPer: p.shariPer, makiG: p.makiG }
                        };
                    })
                    .filter(Boolean);

                return { version: APP_VERSION, date: payload.date || "", lines };
            }

            return { version: APP_VERSION, date: payload?.date || "", lines: [] };
        }

        function exportCsv() {
            const lines = [];
            lines.push(["商品名", "本日パック数", "1Pシャリ(貫)", "合計シャリ(貫)", "合計シャリ(kg)", "金額", "巻物(g)", "巻物(kg)"].join(","));

            PRODUCTS.forEach((p, index) => {
                const input = document.querySelector(`input[data-index="${index}"]`);
                const packs = Number(input.value) || 0;
                const totalShariKan = packs * p.shariPer;
                const totalShariKg = totalShariKan * (GRAMS_PER_KAN / 1000);
                const totalPrice = packs * p.price;
                const totalMakiG = packs * p.makiG;
                const totalMakiKg = totalMakiG / 1000;

                lines.push([
                    `"${p.name}"`,
                    packs,
                    p.shariPer.toFixed(2),
                    totalShariKan.toFixed(2),
                    totalShariKg.toFixed(3),
                    Math.round(totalPrice),
                    totalMakiG.toFixed(0),
                    totalMakiKg.toFixed(3)
                ].join(","));
            });

            const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            const date = new Date().toISOString().slice(0, 10);
            a.href = url;
            a.download = `sushi_daily_${date}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function getProductIndexById(id) {
            return PRODUCTS.findIndex(p => p.id === id);
        }

        function getProductById(id) {
            return PRODUCTS.find(p => p.id === id);
        }

        function makeProductId() {
            return `p_${Date.now()}_${Math.random().toString(16).slice(2)}`;
        }

        function ensureProductIdsAndFlags() {
            let changed = false;

            PRODUCTS = (PRODUCTS || []).map(p => {
                const next = { ...p };

                if (!next.id) {
                    next.id = makeProductId();
                    changed = true;
                }
                if (next.isActive === undefined) {
                    next.isActive = true;
                    changed = true;
                }
                return next;
            });

            if (changed) saveProductConfig();
        }

        function loadProductConfig() {
            const pRaw = localStorage.getItem(PRODUCTS_STORAGE_KEY);
            const nRaw = localStorage.getItem(NETA_MAP_STORAGE_KEY);

            PRODUCTS = pRaw ? JSON.parse(pRaw) : BASE_PRODUCTS;
            PRODUCT_NETA_MAP = nRaw ? JSON.parse(nRaw) : DEFAULT_PRODUCT_NETA_MAP;
        }

        function saveProductConfig() {
            localStorage.setItem(PRODUCTS_STORAGE_KEY, JSON.stringify(PRODUCTS));
            localStorage.setItem(NETA_MAP_STORAGE_KEY, JSON.stringify(PRODUCT_NETA_MAP));
        }

        function buildDailyLinesFromInputs() {
            const inputs = cardsDiv.querySelectorAll('input[data-index]');
            const lines = [];

            inputs.forEach(input => {
                const productId = input.dataset.productId;
                const qty = Number(input.value || 0);
                const p = getProductById(productId);
                if (!p) return;

                if (qty !== 0) {
                    lines.push({
                        productId,
                        qty,
                        snap: {
                            name: p.name,
                            price: p.price,
                            shariPer: p.shariPer,
                            makiG: p.makiG
                        }
                    });
                }
            });

            return lines;
        }

        /**
         * Applies the saved theme ("light" or "dark") from localStorage.
         */
        function applyInitialTheme() {
            const saved = localStorage.getItem("sushi_theme");
            if (saved === "dark" || saved === "light") {
                if (saved === "dark") document.documentElement.classList.add("dark");
                return;
            }
            // follow OS preference
            if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
                document.documentElement.classList.add("dark");
            }
        }

        /**
         * Switches between light and dark themes and saves the choice.
         */
        function toggleTheme() {
            document.documentElement.classList.toggle("dark");
            const isDark = document.documentElement.classList.contains("dark");
            localStorage.setItem("sushi_theme", isDark ? "dark" : "light");
        }

        const versionEl = document.getElementById("versionBadge");
        if (versionEl) {
            versionEl.textContent = `v${APP_VERSION}`;
        }

        // === State & DOM references ===
        const cardsDiv = document.getElementById("cards");
        const totalsBody = document.getElementById("totalsBody");
        const darkToggleBtn = document.getElementById("darkToggle");
        const resetBtn = document.getElementById("resetBtn");
        const printBtn = document.getElementById("printBtn");
        const saveBtn = document.getElementById("saveBtn");
        const csvBtn = document.getElementById("csvBtn");

        function fmtYen(v) {
            return "¥" + Math.round(v).toLocaleString("ja-JP");
        }

        /**
         * Builds the product cards dynamically inside the UI.
         * Uses PRODUCTS[] to generate input fields and result rows.
         * Called only once on page load.
         */
        function buildCards() {
            cardsDiv.innerHTML = "";

            let rollHeaderInserted = false;

            PRODUCTS.forEach((p, index) => {
                if (p.isActive === false) return;
                const isRoll = p.name.endsWith("巻き");

                // Insert 巻物 heading just before the first 巻き item
                if (isRoll && !rollHeaderInserted) {
                    const label = document.createElement("div");
                    label.className = "section-label";
                    label.textContent = "巻物";
                    cardsDiv.appendChild(label);
                    rollHeaderInserted = true;
                }

                const card = document.createElement("article");
                card.className = "card";

                const header = document.createElement("div");
                header.className = "card-header";

                const nameSpan = document.createElement("span");
                nameSpan.className = "name";
                nameSpan.textContent = p.name;
                header.appendChild(nameSpan);

                const actions = document.createElement("div");
                actions.style.display = "flex";
                actions.style.gap = "6px";

                const editBtn = document.createElement("button");
                editBtn.className = "btn secondary";
                editBtn.type = "button";
                editBtn.textContent = "✏ 編集";
                editBtn.addEventListener("click", () => openEditProduct(p.id));

                const delBtn = document.createElement("button");
                delBtn.className = "btn secondary";
                delBtn.type = "button";
                delBtn.textContent = "🗑 削除";
                delBtn.addEventListener("click", () => deleteProduct(p.id));

                actions.appendChild(editBtn);
                actions.appendChild(delBtn);
                header.appendChild(actions);

                const inputWrap = document.createElement("div");
                inputWrap.className = "pack-input-wrap";
                const label = document.createElement("span");
                label.className = "pack-label";
                label.textContent = "本日パック数";
                inputWrap.appendChild(label);

                const packInput = document.createElement("input");
                packInput.type = "number";
                packInput.min = "0";
                packInput.step = "1";
                packInput.value = "0";
                packInput.dataset.productId = p.id;
                inputWrap.appendChild(packInput);

                header.appendChild(inputWrap);
                card.appendChild(header);

                const grid = document.createElement("div");
                grid.className = "rows-grid";

                const rowsInfo = [
                    ["1パック当たりシャリ(貫)", p.shariPer.toFixed(2)],
                    ["合計シャリ(貫)", ""],
                    ["合計シャリ(kg)", ""],
                    ["金額", ""],
                    ["巻物(g)", ""],
                    ["巻物(kg)", ""]
                ];

                rowsInfo.forEach((r, i) => {
                    const row = document.createElement("div");
                    row.className = "card-row";
                    const rowLabel = document.createElement("label");
                    rowLabel.textContent = r[0];
                    const valueSpan = document.createElement("span");
                    if (i === 0) valueSpan.textContent = r[1];
                    valueSpan.dataset.role = `row${p.id}_${i}`;
                    row.appendChild(rowLabel);
                    row.appendChild(valueSpan);
                    grid.appendChild(row);
                });

                card.appendChild(grid);
                cardsDiv.appendChild(card);
            });
        }

        /**
         * Recalculates all totals including:
         * - Shari total (kan)
         * - Shari total (kg)
         * - Makimono rice (g / kg)
         * - Total revenue
         * Updates both the product cards and summary panel.
         */
        function calculateAll() {
            let totalPacks = 0;
            let totalKan = 0;  // にぎり用：貫
            let totalNigiriKg = 0;  // にぎりシャリ(kg)
            let totalYen = 0;
            let totalMakiKg = 0;  // 巻物シャリ(kg)

            PRODUCTS.forEach((p) => {
                if (p.isActive === false) return;
                const input = document.querySelector(`input[data-index="${p.id}"]`);
                const packs = input ? Number(input.value) || 0 : 0;


                // にぎり / 丼 のシャリ(貫) → kg
                const totalShariKan = packs * p.shariPer;
                const nigiriKg = totalShariKan * (GRAMS_PER_KAN / 1000);

                // 金額
                const totalPrice = packs * p.price;

                // 巻物(g) → kg
                const totalMakiG = packs * p.makiG;
                const makiKg = totalMakiG / 1000;

                // この商品の合計シャリ(kg) = にぎり + 巻物
                const totalKgForCard = nigiriKg + makiKg;

                const sel = i => document.querySelector(`[data-role="row${p.id}_${i}"]`);
                // row0: 1パック当たりシャリ(貫)
                if (sel(0)) sel(0).textContent = p.shariPer.toFixed(2);
                // row1: 合計シャリ(貫)
                if (sel(1)) sel(1).textContent = totalShariKan ? totalShariKan.toFixed(2) : "";
                // row2: 合計シャリ(kg)  ※にぎり＋巻物を含めたkg
                if (sel(2)) sel(2).textContent = totalKgForCard ? totalKgForCard.toFixed(3) : "";
                // row3: 金額
                if (sel(3)) sel(3).textContent = totalPrice ? fmtYen(totalPrice) : "";
                // row4: 巻物(g)
                if (sel(4)) sel(4).textContent = totalMakiG ? totalMakiG.toFixed(0) : "";
                // row5: 巻物(kg)
                if (sel(5)) sel(5).textContent = makiKg ? makiKg.toFixed(3) : "";

                // 🔽 トータル集計
                totalPacks += packs;
                totalKan += totalShariKan;
                totalNigiriKg += nigiriKg;
                totalMakiKg += makiKg;
                totalYen += totalPrice;
            });

            const totalAllKg = totalNigiriKg + totalMakiKg; // にぎり＋巻物

            totalsBody.innerHTML = `
                <div class="totals-row"><span>本日パック数合計</span><span>${totalPacks}</span></div>
                <div class="totals-row"><span>本日シャリ合計(貫)</span><span>${totalKan.toFixed(2)}</span></div>
                <div class="totals-row"><span>本日シャリ合計(kg)（にぎり＋巻物）</span><span>${totalAllKg.toFixed(3)}</span></div>
                <div class="totals-row"><span>本日金額合計</span><span>${fmtYen(totalYen)}</span></div>
              `;
            // <div class="totals-row"><span>本日巻物シャリ合計(kg)</span><span>${totalMakiKg.toFixed(3)}</span></div>
        }

        // 印刷用に最後のトータルを保持
        let LAST_PRINT_TOTALS = null;

        // 固定ネタ順（※あとで増やせる）
        const FIXED_NETA_ORDER = [
            "大トロ", "中トロ", "本赤み", "マグロ", "サーモン", "カンパチ",
            "ぶり", "寿エビ", "生エビ", "あじ", "いか", "エンガワ",
            "タイ", "穴子", "角タマ", "焼サモン", "タマゴ"
        ];

        /**
         * 現在の入力（packs）からネタ別必要枚数を集計する
         * 結果は window.INGREDIENT_TOTALS に入れる。
         */
        function computeIngredientTotalsFromInputs() {
            const totals = {}; // { "大トロ": 40, "サーモン": 28, ... }

            PRODUCTS.forEach((p, index) => {
                const input = document.querySelector(`input[data-index="${index}"]`);
                const packs = Number(input?.value) || 0;
                if (!packs) return;

                const netaInfo = PRODUCT_NETA_MAP[p.name];
                if (!netaInfo) return; // ネタ定義のない商品はスキップ

                Object.keys(netaInfo).forEach(neta => {
                    const perPackSlices = netaInfo[neta]; // 1パックの枚数
                    const add = perPackSlices * packs;
                    totals[neta] = (totals[neta] || 0) + add;
                });
            });

            window.INGREDIENT_TOTALS = totals;
        }

        /**
         * 製造サマリー（商品別）テーブルを生成
         */
        function generateProductSummaryTable() {
            let html = `
                    <table class="print-table">
                     <tr>
                        <th>商品名</th>
                        <th>P</th>
                        <th>シャリ(kg)</th>
                        <th>金額</th>
                        <th>巻物</th>
                     </tr>
                 `;

            let totalPacks = 0;
            let totalKan = 0;
            let totalNigiriKg = 0;
            let totalMakiKg = 0;
            let totalYen = 0;

            PRODUCTS.forEach((p, i) => {
                const input = document.querySelector(`input[data-index="${i}"]`);
                const packs = Number(input?.value) || 0;
                if (!packs) return;

                const totalShariKan = packs * p.shariPer;
                const nigiriKg = totalShariKan * (GRAMS_PER_KAN / 1000);
                const totalPrice = packs * p.price;
                const totalMakiG = packs * p.makiG;
                const makiKg = totalMakiG / 1000;
                const totalKgForCard = nigiriKg + makiKg;

                html += `
              <tr>
                <td>${p.name}</td>
                <td>${packs}</td>
                <td>${totalKgForCard.toFixed(3)}</td>
                <td>¥${Math.round(totalPrice).toLocaleString("ja-JP")}</td>
                <td>${totalMakiG}g / ${makiKg.toFixed(3)}kg</td>
              </tr>
            `;

                totalPacks += packs;
                totalKan += totalShariKan;
                totalNigiriKg += nigiriKg;
                totalMakiKg += makiKg;
                totalYen += totalPrice;
            });

            const totalAllKg = totalNigiriKg + totalMakiKg;

            LAST_PRINT_TOTALS = {
                packs: totalPacks,
                kan: totalKan,
                shariKg: totalAllKg,
                makiKg: totalMakiKg,
                yen: totalYen
            };

            html += "</table>";
            return html;
        }

        /**
         * ネタ別必要数テーブル
         * ※ 今はまだ本体側にネタ別集計ロジックがないので、
         *   INGREDIENT_TOTALS が存在する場合だけ使用し、
         *   ない場合は「今後追加予定」のメッセージを出す。
         */

        function generateIngredientList() {
            // 念のため毎回最新状態にする
            computeIngredientTotalsFromInputs();
            const totals = window.INGREDIENT_TOTALS || {};

            let html = `
          <table class="print-table">
            <tr><th>ネタ</th><th>必要枚数</th></tr>
        `;

            let hasAny = false;

            FIXED_NETA_ORDER.forEach(neta => {
                const v = totals[neta] || 0;
                if (v > 0) {
                    hasAny = true;
                    html += `<tr><td>${neta}</td><td>${v}</td></tr>`;
                }
            });

            // もし固定リストに無いネタがあれば「その他」として追加もできる
            Object.keys(totals).forEach(neta => {
                if (!FIXED_NETA_ORDER.includes(neta)) {
                    const v = totals[neta];
                    if (v > 0) {
                        hasAny = true;
                        html += `<tr><td>${neta}</td><td>${v}</td></tr>`;
                    }
                }
            });

            if (!hasAny) {
                html += `
              <tr>
                <td colspan="2">本日ネタ別の必要枚数はありません。</td>
              </tr>
            `;
            }

            html += "</table>";
            return html;
        }

        /**
         * 本日合計テーブル
         */
        function generateTotals() {
            const t = LAST_PRINT_TOTALS || {
                packs: 0,
                shariKg: 0,
                makiKg: 0,
                yen: 0
            };

            return `
          <table class="print-table">
            <tr><th>総パック数</th><td>${t.packs}</td></tr>
            <tr><th>総シャリ量</th><td>${t.shariKg.toFixed(3)} kg</td></tr>
            <tr><th>巻物合計</th><td>${t.makiKg.toFixed(3)} kg</td></tr>
            <tr><th>総売上</th><td>¥${Math.round(t.yen).toLocaleString("ja-JP")}</td></tr>
          </table>
        `;
        }

        function parseNetaConfig(str) {
            const result = {};
            if (!str) return result;

            str.split(",").forEach(part => {
                const pieces = part.split(":");
                if (pieces.length !== 2) return;
                const name = pieces[0].trim();
                const count = Number(pieces[1].trim());
                if (!name || !Number.isFinite(count) || count <= 0) return;
                result[name] = count;
            });
            return result;
        }

        function showAddProductPanel(show) {
            const panel = document.getElementById("addProductPanel");
            if (!panel) return;
            panel.style.display = show ? "block" : "none";
        }

        function openAddProduct() {
            EDITING_PRODUCT_ID = null;

            document.getElementById("newProductName").value = "";
            document.getElementById("newProductPrice").value = "";
            document.getElementById("newProductShari").value = "";
            document.getElementById("newProductMakiG").value = "";
            document.getElementById("newProductNetaConfig").value = "";

            document.getElementById("newProductSaveBtn").textContent = "追加";
            showAddProductPanel(true);
        }

        function openEditProduct(productId) {
            const p = getProductById(productId);
            if (!p) return;

            EDITING_PRODUCT_ID = productId;

            document.getElementById("newProductName").value = p.name ?? "";
            document.getElementById("newProductPrice").value = p.price ?? "";
            document.getElementById("newProductShari").value = p.shariPer ?? "";
            document.getElementById("newProductMakiG").value = p.makiG ?? "";
            const netaObj = PRODUCT_NETA_MAP[productId] || {};
            document.getElementById("newProductNetaConfig").value =
                Object.entries(netaObj).map(([k, v]) => `${k}:${v}`).join(", ");

            document.getElementById("newProductSaveBtn").textContent = "更新";
            showAddProductPanel(true);
        }

        function deleteProduct(productId) {
            const p = getProductById(productId);
            if (!p) return;

            const ok = confirm(`「${p.name}」を削除しますか？\n※過去データを守るため、この商品は“非表示”になります。`);
            if (!ok) return;

            p.isActive = false;
            saveProductConfig();

            buildCards();
            restoreFromStorage();
            calculateAll();
        }

        function buildPrintHtmlDocument() {
            const todayStr = new Date().toLocaleDateString("ja-JP", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                weekday: "short"
            });

            // Use your existing generators to get HTML fragments
            const prodTable = generateProductSummaryTable();
            const ingredientTable = generateIngredientList();
            const totalsTable = generateTotals();

            // Full standalone HTML document for the print window
            return `
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>日次製造サマリー 印刷</title>
  <style>
    @page {
      size: A4 portrait;
      margin: 10mm;
    }
    body {
      font-family: system-ui, -apple-system, "SF Pro Text", "Helvetica Neue", "Segoe UI", sans-serif;
      font-size: 12px;
      color: #000;
      margin: 0;
      padding: 0;
    }
    .print-wrapper {
      padding: 0;
    }
    .print-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4mm;
    }
    .print-date {
      margin-bottom: 3mm;
    }
    .print-hr {
      border: none;
      border-top: 2px solid #000;
      margin: 4mm 0;
    }
    .section-label-print {
      font-weight: 700;
      margin: 3mm 0 2mm;
      font-size: 14px;
    }
    .print-section {
      margin-bottom: 6mm;
      page-break-inside: avoid;
    }
    .print-section-products {
      page-break-after: always; /* page 1 */
    }
    table.print-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 4mm;
      font-size: 12px;
    }
    table.print-table th,
    table.print-table td {
      border: 1px solid #000;
      padding: 3px 6px;
      text-align: left;
      vertical-align: top;
    }
    table.print-table th {
      background: #f3f4f6;
    }
  </style>
</head>
<body>
  <div class="print-wrapper">
    <div class="print-title">日次製造サマリー（鮮魚部）</div>
    <div class="print-date">${todayStr}</div>
    <hr class="print-hr">

    <div class="print-section print-section-products">
      <div class="section-label-print">【製造数まとめ】</div>
      ${prodTable}
    </div>

    <div class="print-section">
      <div class="section-label-print">【ネタ別 必要数（切付用）】</div>
      ${ingredientTable}
    </div>

    <div class="print-section">
      <div class="section-label-print">【本日合計】</div>
      ${totalsTable}
    </div>
  </div>
</body>
</html>
    `;
        }

        /**
         * 印刷用ビュー全体を組み立てる
         */
        function buildPrintView() {
            const div = document.getElementById("printView");
            if (!div) return;

            const todayStr = new Date().toLocaleDateString("ja-JP", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                weekday: "short"
            });

            const prodTable = generateProductSummaryTable();
            const ingredientTable = generateIngredientList();
            const totalsTable = generateTotals();

            div.innerHTML = `
      <div class="print-title">日次製造サマリー（鮮魚部）</div>
      <div class="print-date">${todayStr}</div>
      <hr class="print-hr">

      <div class="print-section print-section-products">
        <div class="section-label-print">【製造数まとめ】</div>
        ${prodTable}
      </div>

      <div class="print-section print-section-ingredients">
        <div class="section-label-print">【ネタ別 必要数（切付用）】</div>
        ${ingredientTable}
      </div>

      <div class="print-section print-section-totals">
        <div class="section-label-print">【本日合計】</div>
        ${totalsTable}
      </div>
    `;
        }

        function attachListeners() {
            cardsDiv.addEventListener("input", (e) => {
                if (e.target.matches('input[type="number"]')) {
                    calculateAll();
                }
            });

            darkToggleBtn.addEventListener("click", () => {
                toggleTheme();
            });

            resetBtn.addEventListener("click", () => {
                document.querySelectorAll('input[type="number"]').forEach(input => {
                    input.value = "0";
                });
                calculateAll();
            });

            printBtn.addEventListener("click", () => {
                // Build the HTML string in the current window (so it can use the inputs)
                const html = buildPrintHtmlDocument();

                // Open a new window/tab for printing
                const printWindow = window.open("", "_blank");

                if (!printWindow) {
                    alert("Popup blocked. Please allow popups for this site to print.");
                    return;
                }

                printWindow.document.open();
                printWindow.document.write(html);
                printWindow.document.close();

                // Give Safari / iOS a moment to render before printing
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                    // Optional: close the print window afterwards
                    printWindow.close();
                }, 500);
            });

            saveBtn.addEventListener("click", () => {
                const payload = {
                    version: APP_VERSION,
                    date: getTodayISO(),
                    lines: buildDailyLinesFromInputs()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
                alert("本日のパック数を保存しました。");
            });

            csvBtn.addEventListener("click", () => {
                exportCsv();
            });

            const toggleBtn = document.getElementById("addProductToggleBtn");
            const saveNewBtn = document.getElementById("newProductSaveBtn");
            const cancelNewBtn = document.getElementById("newProductCancelBtn");

            if (toggleBtn) {
                toggleBtn.addEventListener("click", () => {
                    const panel = document.getElementById("addProductPanel");
                    const isVisible = panel && panel.style.display === "block";
                    showAddProductPanel(!isVisible);
                });
            }

            if (cancelNewBtn) {
                cancelNewBtn.addEventListener("click", () => {
                    showAddProductPanel(false);
                });
            }

            if (saveNewBtn) {
                saveNewBtn.addEventListener("click", () => {
                    const name = document.getElementById("newProductName").value.trim();
                    const price = Number(document.getElementById("newProductPrice").value || 0);
                    const shari = Number(document.getElementById("newProductShari").value || 0);
                    const makiG = Number(document.getElementById("newProductMakiG").value || 0);
                    const netaText = document.getElementById("newProductNetaConfig").value;

                    // your existing validation here
                    if (!name) { alert("商品名を入力してください"); return; }

                    const netaMap = parseNetaConfig(netaText); // use your existing parser

                    if (!EDITING_PRODUCT_ID) {
                        // ✅ ADD
                        const newProduct = {
                            id: makeProductId(),
                            name,
                            price,
                            shariPer: Number.isFinite(shari) ? shari : 0,
                            makiG: Number.isFinite(makiG) ? makiG : 0,
                            isActive: true
                        };
                        PRODUCTS.push(newProduct);
                        if (Object.keys(netaMap).length) PRODUCT_NETA_MAP[newProduct.name] = netaMap;
                    } else {
                        // ✅ UPDATE
                        const idx = PRODUCTS.findIndex(p => p.id === EDITING_PRODUCT_ID);
                        if (idx === -1) return;

                        const oldName = PRODUCTS[idx].name;
                        PRODUCTS[idx] = { ...PRODUCTS[idx], name, price, shariPer: shari, makiG };

                        // if name-based neta map, move key if renamed:
                        if (oldName !== name && PRODUCT_NETA_MAP[oldName]) {
                            PRODUCT_NETA_MAP[name] = PRODUCT_NETA_MAP[oldName];
                            delete PRODUCT_NETA_MAP[oldName];
                        }
                        if (Object.keys(netaMap).length) PRODUCT_NETA_MAP[name] = netaMap;
                    }

                    saveProductConfig();
                    localStorage.setItem(NETA_MAP_STORAGE_KEY, JSON.stringify(PRODUCT_NETA_MAP));

                    showAddProductPanel(false);
                    buildCards();
                    restoreFromStorage();
                    calculateAll();
                });
            }
        }

        // PWA registration with version log
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("service-worker.js")
                    .then(reg => {
                        console.log("SW registered:", reg.scope, "version", APP_VERSION);
                    })
                    .catch(err => console.error("SW registration failed:", err));
            });

            // 🔔 listen for "NEW_VERSION" from the SW and auto-reload
            navigator.serviceWorker.addEventListener("message", (event) => {
                if (event.data && event.data.type === "NEW_VERSION") {
                    console.log("New SW version available, reloading page...");
                    window.location.reload();
                }
            });
        }

        // Init
        applyInitialTheme();
        loadProductConfig();
        ensureProductIdsAndFlags();
        buildCards();
        restoreFromStorage();
        calculateAll();
        attachListeners();
    </script>
</body>
</html>
