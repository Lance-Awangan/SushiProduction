<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- Basic meta -->
    <meta charset="UTF-8" />
    <title>寿司 日次生産アプリ v0.1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- PWA manifest (Android & others) -->
    <link rel="manifest" href="manifest.json" />

    <!-- Theme color for Android status bar -->
    <meta name="theme-color" content="#1976d2" />

    <!-- iOS: enable PWA mode (fullscreen) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="寿司生産">

    <!-- iOS: app icon (home screen) -->
    <link rel="apple-touch-icon" href="icons/apple-icon-180.png">

    <!-- Optional: iOS splash screens (you can skip at first) -->
    <!-- Example sizes (you add these files only if you want custom splash) -->
    <!--
    <link rel="apple-touch-startup-image" href="/splash/splash-640x1136.png"
          media="(device-width: 320px) and (device-height: 568px)
                 and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/splash/splash-750x1334.png"
          media="(device-width: 375px) and (device-height: 667px)
                 and (-webkit-device-pixel-ratio: 2)">
    -->
    <!-- Your CSS & JS -->
    <link rel="stylesheet" href="main.css">
    <script defer src="main.js"></script>

    <style>
        :root {
            --bg: #f5f5f7;
            --card-bg: #ffffff;
            --text-main: #111827;
            --text-sub: #4b5563;
            --accent: #2563eb;
            --accent-soft: #dbeafe;
            --border-subtle: #e5e7eb;
            --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
        }

            :root.dark {
                --bg: #050816;
                --card-bg: #020617;
                --text-main: #f9fafb;
                --text-sub: #9ca3af;
                --accent: #60a5fa;
                --accent-soft: #0b1220;
                --border-subtle: #1f2933;
                --shadow-soft: 0 16px 40px rgba(15, 23, 42, 0.7);
            }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", "Segoe UI", sans-serif;
            margin: 0;
            padding: 12px;
            background: radial-gradient(circle at top, #e0f2fe 0, var(--bg) 55%);
            color: var(--text-main);
            min-height: 100vh;
        }

        .app-shell {
            max-width: 960px;
            margin: 0 auto;
        }

        .toolbar {
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(16px);
            margin-bottom: 10px;
        }

        .toolbar-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 8px 10px;
            border-radius: 16px;
            background: color-mix(in srgb, var(--card-bg) 85%, transparent);
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.15);
        }

        .title-area {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .title-main {
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 0.03em;
        }

        .title-sub {
            font-size: 0.75rem;
            color: var(--text-sub);
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .chip {
            font-size: 0.68rem;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            color: var(--text-sub);
            background: color-mix(in srgb, var(--card-bg) 80%, transparent);
        }

            .chip strong {
                color: var(--accent);
            }

        .btn {
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid transparent;
            font-size: 0.78rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
        }

            .btn.secondary {
                background: color-mix(in srgb, var(--card-bg) 90%, var(--accent-soft));
                color: var(--text-main);
                border-color: var(--border-subtle);
                box-shadow: none;
            }

            .btn.icon-only {
                padding-inline: 8px;
                width: 32px;
                justify-content: center;
            }

            .btn:active {
                transform: translateY(1px);
                box-shadow: none;
                opacity: 0.95;
            }

        .cards {
            margin-top: 12px;
            display: grid;
            grid-template-columns: minmax(0, 1fr);
            gap: 10px;
        }

        @media (min-width: 720px) {
            .cards {
                grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 10px 12px;
            box-shadow: var(--shadow-soft);
            border: 1px solid color-mix(in srgb, var(--border-subtle) 60%, transparent);
            font-size: 0.85rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            gap: 8px;
        }

        .name {
            font-weight: 600;
            font-size: 0.95rem;
            padding: 2px 8px;
            border-radius: 999px;
            background: var(--accent-soft);
            color: var(--accent);
        }

        .pack-input-wrap {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .pack-label {
            font-size: 0.7rem;
            color: var(--text-sub);
        }

        input[type="number"] {
            width: 70px;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            background: color-mix(in srgb, var(--card-bg) 95%, #0f172a 5%);
            text-align: right;
            font-size: 0.85rem;
            color: var(--text-main);
        }

            input[type="number"]:focus {
                outline: 2px solid var(--accent-soft);
                border-color: var(--accent);
            }

        .rows-grid {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
            gap: 4px 10px;
            margin-top: 4px;
        }

        .card-row {
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 3px 0;
            border-bottom: 1px dashed color-mix(in srgb, var(--border-subtle) 80%, transparent);
        }

            .card-row:last-child {
                border-bottom: none;
            }

            .card-row label {
                font-size: 0.7rem;
                color: var(--text-sub);
            }

            .card-row span {
                font-size: 0.83rem;
            }

        .totals {
            margin-top: 12px;
            padding: 10px 12px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-soft);
            border: 1px solid color-mix(in srgb, var(--border-subtle) 70%, transparent);
            font-size: 0.85rem;
        }

        .totals-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .totals-title {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .totals-body {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
            gap: 4px 12px;
        }

        .totals-row {
            display: flex;
            justify-content: space-between;
            gap: 4px;
        }

            .totals-row span:first-child {
                font-size: 0.78rem;
                color: var(--text-sub);
            }

            .totals-row span:last-child {
                font-weight: 500;
            }

        .version-tag {
            font-size: 0.7rem;
            color: var(--text-sub);
        }

        .section-label {
            margin-top: 12px;
            margin-bottom: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-sub);
            padding: 0 4px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            opacity: 0.8;
        }


        @media print {
            body {
                background: #ffffff;
                padding: 0;
            }

            .toolbar {
                display: none;
            }

            .app-shell {
                max-width: none;
            }

            .card {
                box-shadow: none;
                border-radius: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <header class="toolbar">
            <div class="toolbar-inner">
                <div class="title-area">
                    <div class="title-main">寿司 日次生産入力</div>
                    <div class="title-sub">シャリ・巻物・金額を自動集計するミニアプリ</div>
                </div>
                <div class="toolbar-right">
                    <div class="chip">
                        <strong>v-0.1</strong>・オフライン対応
                    </div>
                    <button class="btn secondary" id="darkToggle" title="ダークモード切替">
                        🌙
                    </button>
                    <button class="btn secondary" id="saveBtn">
                        💾 保存
                    </button>
                    <button class="btn secondary" id="csvBtn">
                        📄 CSV
                    </button>
                    <button class="btn secondary" id="resetBtn">
                        ♻ リセット
                    </button>
                    <button class="btn" id="printBtn">
                        🖨 印刷
                    </button>
                </div>
            </div>
        </header>

        <main>
            <section class="cards" id="cards"></section>
            <section class="totals" id="totals">
                <div class="totals-header">
                    <div class="totals-title">本日サマリー</div>
                    <div class="version-tag">寿司アプリ v0.1</div>
                </div>
                <div class="totals-body" id="totalsBody"></div>
            </section>
        </main>
    </div>

    <script>
        const APP_VERSION = "0.1.3";
        const STORAGE_KEY = "sushi_daily_packs_v0.1.3";
        /**
         * Constant: grams per 1 kan (貫)
         * Changing this affects all kg calculations.
         */
        const GRAMS_PER_KAN = 17.5;

        /**
         * PRODUCTS:
         * The master product list used to build the UI.
         * - name: Display name
         * - price: Price per pack (JPY)
         * - shariPer: Shari per pack (kan)
         * - makiG: Rice grams for makimono (0 for nigiri items)
         */
        const PRODUCTS = [
            { name: "真", price: 7990, shariPer: 40.0, makiG: 0.0 },
            { name: "美", price: 4990, shariPer: 33.0, makiG: 160.0 },
            { name: "善", price: 5990, shariPer: 36.0, makiG: 160.0 },
            { name: "海峡", price: 3990, shariPer: 24.0, makiG: 0.0 },
            { name: "さざ波", price: 2800, shariPer: 24.0, makiG: 0.0 },
            { name: "松", price: 1590, shariPer: 10.0, makiG: 0.0 },
            { name: "竹", price: 1390, shariPer: 10.0, makiG: 0.0 },
            { name: "梅", price: 1290, shariPer: 6.0, makiG: 80.0 },
            { name: "赤レンジアー", price: 1200, shariPer: 6.0, makiG: 80.0 },
            { name: "白レンジアー", price: 990, shariPer: 9.0, makiG: 0.0 },
            { name: "虹レンジアー", price: 990, shariPer: 8.0, makiG: 40.0 },
            { name: "橙レンジアー", price: 990, shariPer: 6.0, makiG: 80.0 },
            { name: "茶助レンジアー", price: 990, shariPer: 3.0, makiG: 0.0 },
            { name: "青レンジアー", price: 990, shariPer: 3.0, makiG: 0.0 },
            { name: "マグロ", price: 690, shariPer: 6.0, makiG: 0.0 },
            { name: "タイ", price: 680, shariPer: 6.0, makiG: 0.0 },
            { name: "サモン", price: 680, shariPer: 6.0, makiG: 0.0 },
            { name: "ぶり", price: 699, shariPer: 6.0, makiG: 0.0 },
            { name: "エビ", price: 590, shariPer: 6.0, makiG: 0.0 },
            { name: "あじ", price: 599, shariPer: 6.0, makiG: 0.0 },
            { name: "鉄火巻き", price: 599, shariPer: 0.0, makiG: 80.0 },
            { name: "ネギトロ巻き", price: 499, shariPer: 0.0, makiG: 80.0 },
            { name: "海鮮巻き", price: 599, shariPer: 0.0, makiG: 230.0 },
            { name: "海鮮丼", price: 990, shariPer: 0.0, makiG: 200.0 },
            { name: "昆布巻き", price: 499, shariPer: 0.0, makiG: 140.0 },
            { name: "サモン巻き", price: 450, shariPer: 0.0, makiG: 120.0 },
            { name: "トロタク巻き", price: 499, shariPer: 0.0, makiG: 120.0 },
        ];


        /**
         * Applies the saved theme ("light" or "dark") from localStorage.
         */
        function applyInitialTheme() {
            const saved = localStorage.getItem("sushi_theme");
            if (saved === "dark" || saved === "light") {
                if (saved === "dark") document.documentElement.classList.add("dark");
                return;
            }
            // follow OS preference
            if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
                document.documentElement.classList.add("dark");
            }
        }

        /**
         * Switches between light and dark themes and saves the choice.
         */
        function toggleTheme() {
            document.documentElement.classList.toggle("dark");
            const isDark = document.documentElement.classList.contains("dark");
            localStorage.setItem("sushi_theme", isDark ? "dark" : "light");
        }

        // === State & DOM references ===
        const cardsDiv = document.getElementById("cards");
        const totalsBody = document.getElementById("totalsBody");
        const darkToggleBtn = document.getElementById("darkToggle");
        const resetBtn = document.getElementById("resetBtn");
        const printBtn = document.getElementById("printBtn");
        const saveBtn = document.getElementById("saveBtn");
        const csvBtn = document.getElementById("csvBtn");

        function fmtYen(v) {
            return "¥" + Math.round(v).toLocaleString("ja-JP");
        }

        /**
         * Builds the product cards dynamically inside the UI.
         * Uses PRODUCTS[] to generate input fields and result rows.
         * Called only once on page load.
         */
        function buildCards() {
            cardsDiv.innerHTML = "";

            let rollHeaderInserted = false;

            PRODUCTS.forEach((p, index) => {
                const isRoll = p.name.endsWith("巻き");

                // Insert 巻物 heading just before the first 巻き item
                if (isRoll && !rollHeaderInserted) {
                    const label = document.createElement("div");
                    label.className = "section-label";
                    label.textContent = "巻物";
                    cardsDiv.appendChild(label);
                    rollHeaderInserted = true;
                }

                const card = document.createElement("article");
                card.className = "card";

                const header = document.createElement("div");
                header.className = "card-header";

                const nameSpan = document.createElement("span");
                nameSpan.className = "name";
                nameSpan.textContent = p.name;
                header.appendChild(nameSpan);

                const inputWrap = document.createElement("div");
                inputWrap.className = "pack-input-wrap";
                const label = document.createElement("span");
                label.className = "pack-label";
                label.textContent = "本日パック数";
                inputWrap.appendChild(label);

                const packInput = document.createElement("input");
                packInput.type = "number";
                packInput.min = "0";
                packInput.step = "1";
                packInput.value = "0";
                packInput.dataset.index = index;
                inputWrap.appendChild(packInput);

                header.appendChild(inputWrap);
                card.appendChild(header);

                const grid = document.createElement("div");
                grid.className = "rows-grid";

                const rowsInfo = [
                    ["1パック当たりシャリ(貫)", p.shariPer.toFixed(2)],
                    ["合計シャリ(貫)", ""],
                    ["合計シャリ(kg)", ""],
                    ["金額", ""],
                    ["巻物(g)", ""],
                    ["巻物(kg)", ""]
                ];

                rowsInfo.forEach((r, i) => {
                    const row = document.createElement("div");
                    row.className = "card-row";
                    const rowLabel = document.createElement("label");
                    rowLabel.textContent = r[0];
                    const valueSpan = document.createElement("span");
                    if (i === 0) valueSpan.textContent = r[1];
                    valueSpan.dataset.role = `row${index}_${i}`;
                    row.appendChild(rowLabel);
                    row.appendChild(valueSpan);
                    grid.appendChild(row);
                });

                card.appendChild(grid);
                cardsDiv.appendChild(card);
            });
        }

        /**
         * Recalculates all totals including:
         * - Shari total (kan)
         * - Shari total (kg)
         * - Makimono rice (g / kg)
         * - Total revenue
         * Updates both the product cards and summary panel.
         */
        function calculateAll() {
            let totalPacks = 0;
            let totalKan = 0;  // にぎり用：貫
            let totalNigiriKg = 0;  // にぎりシャリ(kg)
            let totalYen = 0;  
            let totalMakiKg = 0;  // 巻物シャリ(kg)

            PRODUCTS.forEach((p, index) => {
                const input = document.querySelector(`input[data-index="${index}"]`);
                const packs = Number(input.value) || 0;

                // にぎり / 丼 のシャリ(貫) → kg
                const totalShariKan = packs * p.shariPer;
                const nigiriKg = totalShariKan * (GRAMS_PER_KAN / 1000);

                // 金額
                const totalPrice = packs * p.price;

                // 巻物(g) → kg
                const totalMakiG = packs * p.makiG;
                const makiKg = totalMakiG / 1000;

                // この商品の合計シャリ(kg) = にぎり + 巻物
                const totalKgForCard = nigiriKg + makiKg;

                const sel = i => document.querySelector(`[data-role="row${index}_${i}"]`);
                // row0: 1パック当たりシャリ(貫)
                if (sel(0)) sel(0).textContent = p.shariPer.toFixed(2);
                // row1: 合計シャリ(貫)
                if (sel(1)) sel(1).textContent = totalShariKan ? totalShariKan.toFixed(2) : "";
                // row2: 合計シャリ(kg)  ※にぎり＋巻物を含めたkg
                if (sel(2)) sel(2).textContent = totalKgForCard ? totalKgForCard.toFixed(3) : "";
                // row3: 金額
                if (sel(3)) sel(3).textContent = totalPrice ? fmtYen(totalPrice) : "";
                // row4: 巻物(g)
                if (sel(4)) sel(4).textContent = totalMakiG ? totalMakiG.toFixed(0) : "";
                // row5: 巻物(kg)
                if (sel(5)) sel(5).textContent = makiKg ? makiKg.toFixed(3) : "";

                // 🔽 トータル集計
                totalPacks += packs;
                totalKan += totalShariKan;
                totalNigiriKg += nigiriKg;
                totalMakiKg += makiKg;
                totalYen += totalPrice;
            });

            const totalAllKg = totalNigiriKg + totalMakiKg; // にぎり＋巻物

            totalsBody.innerHTML = `
            <div class="totals-row"><span>本日パック数合計</span><span>${totalPacks}</span></div>
            <div class="totals-row"><span>本日シャリ合計(貫)</span><span>${totalKan.toFixed(2)}</span></div>
            <div class="totals-row"><span>本日シャリ合計(kg)（にぎり＋巻物）</span><span>${totalAllKg.toFixed(3)}</span></div>
            <div class="totals-row"><span>本日金額合計</span><span>${fmtYen(totalYen)}</span></div>
          `;
            // <div class="totals-row"><span>本日巻物シャリ合計(kg)</span><span>${totalMakiKg.toFixed(3)}</span></div>
        }

        function attachListeners() {
            cardsDiv.addEventListener("input", (e) => {
                if (e.target.matches('input[type="number"]')) {
                    calculateAll();
                }
            });

            darkToggleBtn.addEventListener("click", () => {
                toggleTheme();
            });

            resetBtn.addEventListener("click", () => {
                document.querySelectorAll('input[type="number"]').forEach(input => {
                    input.value = "0";
                });
                calculateAll();
            });

            printBtn.addEventListener("click", () => {
                window.print();
            });

            saveBtn.addEventListener("click", () => {
                const packs = PRODUCTS.map((p, index) => {
                    const input = document.querySelector(`input[data-index="${index}"]`);
                    return Number(input.value) || 0;
                });
                const payload = {
                    version: APP_VERSION,
                    date: new Date().toISOString().slice(0, 10),
                    packs
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
                alert("本日のパック数を保存しました。");
            });

            csvBtn.addEventListener("click", () => {
                exportCsv();
            });
        }

        function restoreFromStorage() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            try {
                const data = JSON.parse(raw);
                if (!Array.isArray(data.packs)) return;
                data.packs.forEach((v, index) => {
                    const input = document.querySelector(`input[data-index="${index}"]`);
                    if (input) input.value = v;
                });
            } catch (_) { }
        }

        function exportCsv() {
            const lines = [];
            lines.push(["商品名", "本日パック数", "1Pシャリ(貫)", "合計シャリ(貫)", "合計シャリ(kg)", "金額", "巻物(g)", "巻物(kg)"].join(","));

            PRODUCTS.forEach((p, index) => {
                const input = document.querySelector(`input[data-index="${index}"]`);
                const packs = Number(input.value) || 0;
                const totalShariKan = packs * p.shariPer;
                const totalShariKg = totalShariKan * (GRAMS_PER_KAN / 1000);
                const totalPrice = packs * p.price;
                const totalMakiG = packs * p.makiG;
                const totalMakiKg = totalMakiG / 1000;

                lines.push([
                    `"${p.name}"`,
                    packs,
                    p.shariPer.toFixed(2),
                    totalShariKan.toFixed(2),
                    totalShariKg.toFixed(3),
                    Math.round(totalPrice),
                    totalMakiG.toFixed(0),
                    totalMakiKg.toFixed(3)
                ].join(","));
            });

            const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            const date = new Date().toISOString().slice(0, 10);
            a.href = url;
            a.download = `sushi_daily_${date}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // PWA registration with version log
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("service-worker.js")
                    .then(reg => {
                        console.log("SW registered:", reg.scope, "version", APP_VERSION);
                    })
                    .catch(err => console.error("SW registration failed:", err));
            });

            // 🔔 listen for "NEW_VERSION" from the SW and auto-reload
            navigator.serviceWorker.addEventListener("message", (event) => {
                if (event.data && event.data.type === "NEW_VERSION") {
                    console.log("New SW version available, reloading page...");
                    window.location.reload();
                }
            });
        }

        // Init
        applyInitialTheme();
        buildCards();
        restoreFromStorage();
        calculateAll();
        attachListeners();
    </script>
</body>
</html>
